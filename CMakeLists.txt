cmake_minimum_required(VERSION 3.18)

project(test_superbuild)

include(ExternalProject)

set(INSTALL_STAGING_DIR "${CMAKE_CURRENT_BINARY_DIR}/install")

set(MULTI_CONFIG_ARGS)
if(${GENERATOR_IS_MULTI_CONFIG})
	list(APPEND MULTI_CONFIG_ARGS
		-DCMAKE_CONFIGURATION_TYPES=${CMAKE_CONFIGURATION_TYPES})
endif()

set(OPENCV_CMAKE_ARGS
	-DBUILD_SHARED_LIBS=OFF
	-DBUILD_OPENCV_APPS=OFF
	-DBUILD_ANDROID_EXAMPLES=OFF
	-DBUILD_DOCS=OFF
	-DBUILD_EXAMPLES=OFF
	-DBUILD_PACKAGE=OFF
	-DBUILD_PERF_TESTS=OFF
	-DBUILD_TESTS=OFF
	-DBUILD_WITH_DEBUG_INFO=OFF
	-DBUILD_FAT_JAVA_LIB=OFF
	-DBUILD_ANDROID_SERVICE=OFF
	-DBUILD_ANDROID_PACKAGE=OFF
	-DBUILD_TINY_GPU_MODULE=OFF
	-DENABLE_PRECOMPILED_HEADERS=OFF
	-DWITH_GTK=OFF
	-DENABLE_FAST_MATH=OFF
	-DWITH_PROTOBUF=OFF
	-DBUILD_PROTOBUF=OFF
	-DWITH_IPP=OFF
	-DWITH_ITT=OFF
	-DWITH_DSHOW=OFF
	-DWITH_MSMF=OFF
	-DWITH_FFMPEG=OFF
	-DWITH_EIGEN=OFF
	-DWITH_TBB=OFF
	-DWITH_OPENMP=OFF
	-DWITH_PTHREADS_PF=OFF
	-DWITH_OPENJPEG=OFF
	-DBUILD_OPENJPEG=OFF
	-DWITH_TIFF=OFF
	-DBUILD_TIFF=OFF
	-DWITH_PNG=OFF
	-DWITH_JASPER=OFF
	-DWITH_JPEG=OFF
	-DBUILD_PNG=OFF
	-DBUILD_ZLIB=OFF
	-DBUILD_JASPER=OFF
	-DBUILD_JPEG=OFF
	-DWITH_ADE=OFF
	-DBUILD_LIST="core,ml,imgproc,highgui,flann,features2d,calib3d,video,objdetect,photo"
)

if("${TARGET_PLATFORM}" MATCHES "win*")
	list(APPEND OPENCV_CMAKE_ARGS -DBUILD_WITH_STATIC_CRT=ON)
endif()

if ("${TARGET_PLATFORM}" MATCHES "apple32")
	list(APPEND OPENCV_CMAKE_ARGS -DWITH_LAPACK=OFF)
endif()

ExternalProject_Add(OpenCV
	SOURCE_DIR ${PROJECT_SOURCE_DIR}/opencv
	CMAKE_ARGS
		${OPENCV_CMAKE_ARGS}
		${MULTI_CONFIG_ARGS}
		-DCMAKE_INSTALL_PREFIX=${INSTALL_STAGING_DIR}
)

ExternalProject_Add(test_project
	SOURCE_DIR ${PROJECT_SOURCE_DIR}/test_project
	CMAKE_ARGS
		${MULTI_CONFIG_ARGS}
		-DCMAKE_INSTALL_PREFIX=${INSTALL_STAGING_DIR}
)
ExternalProject_Add_StepDependencies(test_project OpenCV)
